<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
  <title>Custom Entity Development</title>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />

  <link rel="stylesheet" href="/style/style.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/style/toc.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/style/docs/code.css" type="text/css" media="screen" />

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  
	<!-- Sidebar/ToC Scripts and CSS -->
	<script src="/style/js/jquery/jquery-1.7.1.min.js"></script>
	<script src="/style/js/jquery/jquery-ui-1.8.18.custom.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/style/js/jquery/smoothness/jquery-ui-1.8.18.custom.css" />
	
	<script type="text/javascript" src="/style/js/superfish.js"></script>
	
<!-- Clipboard support -->
<script src="/style/js/zeroclipboard/ZeroClipboard.js"></script>
<style type="text/css">
.clipboard_container { float: right; padding: 8px; }
.clipboard_button {
    background-image: url("/style/icons/clipboard-green-normal.png");
    background-size: 18px 21px;
    width: 18px; height: 21px;
}
.clipboard_button.hover  { background-image: url("/style/icons/clipboard-green-hover.png"); }
.clipboard_button.active  { background-image: url("/style/icons/clipboard-green-click.png"); }'
</style>
<script type="text/javascript"> <!-- clipboard -->
ZeroClipboard.setMoviePath( '/style/js/zeroclipboard/ZeroClipboard.swf' );
</script>
<script type="text/javascript"> <!-- clipboard positioning -->
$(document).ready(function() {
  $('<div class="clipboard_container" title="Copy to Clipboard">'+
    '<div class="clipboard_button"/>'+
  '</div>').insertBefore($('div.highlight'))
  $('div.clipboard_container').each(function(index) {
    var clipboard = new ZeroClipboard.Client();
    clipboard.glue( $(this).find(":first")[0], $(this)[0] );
    var target = $(this).next();
    var txt = target.text().trim();
    if (target.find('code.bash')) {
      txt = txt.replace(/^[^%$]*[%$] /, "").replace(new RegExp('\n[^%$]*[%$] ','g'), "\n");
    }
    clipboard.setText(txt);
  });
});
</script>

    <script type="text/javascript">
        // initialise menu delay
        jQuery(function(){
            jQuery('ul#mainmenu').superfish({ 
                autoArrows:  false,  // disable generation of arrow mark-up 
                dropShadows: false,  // disable drop shadows 
                disableHI:   true,   // set to true to disable hoverIntent detection 
                delay:       500,    // the delay in milliseconds that the mouse can remain outside a submenu without it closing 
                speed:       'fast', 
            });
        });
    </script>

<script type="text/javascript"> <!-- search -->
	$(function() {
		$('#simple_google')
			.submit(function() {
				$('input[name="q"]').val("site:" + document.location.hostname + " " + $('input[name="brooklyn-search"]').val());
			return true;
			});
		$('input[name="brooklyn-search"]').focus(function() {
				if ($(this).val() === $(this).attr('placeholder')) {
					$(this).val('');
				}
			})
			.blur(function() {
				if ($(this).val() === '') {
					$(this).val($(this).attr('placeholder'));
				}
			})
			.blur();
    });
</script>

<script type="text/javascript"> <!-- analytics -->
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-30530918-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</head>

<body>

    <ul id="shortcuts" title="Accessibility shortcuts menu">
        <li><a href="#maincontent">Skip to main content</a></li>
    </ul>
   

<div id="container">

    <div id="header">
    
        <div id="identity">
            <a href="http://brooklyncentral.github.com/" rel="home">Brooklyn</a>
        </div>
        
        <ul id="quicklinks">
            <li><a href="/meta/contact.html">Contact</a></li>
            <li><a href="/start/download.html">Download</a></li>
            <li><a href="https://twitter.com/#!/search?q=brooklyncentral">Twitter</a></li>
            <li><a href="https://github.com/brooklyncentral">GitHub</a></li>
        </ul>

        <div id="menubar">  







<ul id="mainmenu"><!-- INSERT LINKS -->
            

  
  
  <li class=""><a href="/index.html">Overview</a></li>

  
  
  <li class=""><a href="/start/download.html">Download</a></li>

  
  
  <li class=""><a href="/start/walkthrough/index.html">Walkthrough</a></li>

  
  
  <li class="toc-active"><a href="/use/guide/index.html">Guide</a></li>

  
  
  <li class=""><a href="/use/examples/index.html">Examples</a></li>

  
  
  <li class=""><a href="/dev/code/index.html">Contributing</a></li>


</ul>                    

            <form method="get" id="simple_google" class="searchform" action="http://www.google.com/search" method="get">
                <input type="text" class="searchinput" name="brooklyn-search" placeholder="Search: type &amp; hit enter" />
                <input type="hidden" name="q" value="" />
            </form>
            
        </div>
                
    </div><!--header-->
    
    <div id="contentcontainer">
    
        <div id="maincontent">


  







    
    

    
    
        
        
    
        
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
    
        
            
            
            
            
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
        
            
        
            
        
            
        
            
        
            
        
    
        
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
    



            
<p id="breadcrumb">
    <a href="/use/guide/index.html">User Guide</a>
    
        &raquo; <a href="/use/guide/entities/index.html">Custom Entities</a>
        
    
</p>


<h1 id="header_title">Custom Entity Development</h1>
    
<p>This section details how to create new custom application components or groups as brooklyn entities.</p>

<p><a name="entity-lifestyle"></a></p>

<h2>The Entity Lifecycle</h2>

<ul>
<li>Importance of serialization, ref to How mananagement works</li>
<li>Ownership (children) and Membership (groups)</li>
</ul>


<p><a name="implementation-classes"></a></p>

<h2>What to Extend -- Implementation Classes</h2>

<ul>
<li><p>entity implementation class hierarchy</p>

<ul>
<li><code>SoftwareProcessEntity</code> as the main starting point for base entities (corresponding to software processes),
and subclasses such as <code>VanillaJavaApp</code></li>
<li><code>DynamicCluster</code> (multiple instances of the same entity in a location) and
<code>DynamicFabric</code> (clusters in multiple location) for automatically creating many instances,
supplied with an <code>EntityFactory</code> (e.g. <code>BaseEntityFactory</code>) in the <code>factory</code> flag</li>
<li>abstract <code>Group</code> for collecting entities which are owned elsewhere in the hierachy</li>
<li><code>AbstractEntity</code> if nothing else fits</li>
</ul>
</li>
<li><p>traits (mixins, otherwise known as interfaces with statics) to define available config keys, sensors, and effectors;
  and conveniences e.g. <code>StartableMethods.{start,stop}</code> is useful for entities which implement <code>Startable</code></p></li>
<li><p>the <code>Entities</code> class provides some generic convenience methods; worth looking at it for any work you do</p></li>
</ul>


<p>A common lifecycle pattern is that the <code>start</code> effector (see more on effectors below) is invoked,
often delegating either to a driver (for software processes) or children entities (for clusters etc).</p>

<p>See <code>JBoss7Server</code> and <code>MySqlNode</code> for exemplars.</p>

<p><a name="configuration"></a></p>

<h2>Configuration</h2>

<!---
TODO: why to use config?
-->


<ul>
<li><p>AttributeSensorAndConfigKey fields can be automatically converted for <code>SoftwareProcessEntity</code>.
This is done in <code>preStart()</code>. This must be done manually if required for other entities,
often with <code>ConfigSensorAdapter.apply(this)</code>.</p></li>
<li><p>Setting ports is a special challenge, and one which the <code>AttributeSensorAndConfigKey</code> is particularly helpful for,
cf <code>PortAttributeSensorAndConfigKey</code> (a subclass),
causing ports automatically get assigned from a range and compared with the target <code>PortSupplied</code> location.</p>

<p>Syntax is as described in the PortRange interface. For example, "8080-8099,8800+" will try port 8080, try sequentially through 8099, then try from 8800 until all ports are exhausted.</p>

<p>This is particularly useful on a contended machine (localhost!). Like ordinary configuration, the config is done by the user, and the actual port used is reported back as a sensor on the entity.</p></li>
</ul>


<p><a name="implementing-sensors"></a></p>

<h2>Implementing Sensors</h2>

<ul>
<li>e.g. HTTP, JMX</li>
</ul>


<p>Sensors at base entities are often retrieved by adapters which poll the entity's corresponding instance in the real world.
The <code>SoftwareProcessEntity</code> provides a good example; by subclassing it and overriding the <code>connectSensors()</code> method
you could wire some example sensors using the following:</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectSensors</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">connectSensors</span><span class="o">()</span>
    <span class="n">def</span> <span class="n">http</span> <span class="o">=</span> <span class="n">sensorRegistry</span><span class="o">.</span><span class="na">register</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">HttpSensorAdapter</span><span class="o">(</span><span class="n">mgmtUrl</span><span class="o">,</span>
                                <span class="nl">period:</span> <span class="mi">200</span><span class="o">*</span><span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span>
        <span class="o">)</span>
    <span class="n">http</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">SERVICE_UP</span><span class="o">,</span> <span class="o">{</span> <span class="n">responseCode</span><span class="o">==</span><span class="mi">200</span> <span class="o">})</span>
    <span class="n">http</span><span class="o">.</span><span class="na">suburl</span><span class="o">(</span><span class="s">&quot;requests&quot;</span><span class="o">).</span><span class="na">poll</span><span class="o">(</span><span class="n">REQUEST_COUNT</span><span class="o">)</span>
    <span class="n">http</span><span class="o">.</span><span class="na">suburl</span><span class="o">(</span><span class="s">&quot;requestDurationsAsJsonList&quot;</span><span class="o">).</span><span class="na">poll</span><span class="o">(</span><span class="n">MAX_PER_SITE</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">(</span><span class="n">json</span><span class="o">.</span><span class="na">durations</span> <span class="n">as</span> <span class="n">List</span><span class="o">).</span><span class="na">collect</span><span class="o">({</span> <span class="n">it</span> <span class="n">as</span> <span class="n">Long</span> <span class="o">}).</span><span class="na">max</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>


<p>In this example</p>

<ul>
<li><p><code>url+"/requests</code> serves up the request count as a string,</p></li>
<li><p><code>url+"/requestDurationsAsJsonList"</code> returns a JSON string, (which the adapter's <code>json</code> field in the closure lets us access as a map.)</p></li>
<li><p><code>responseCode</code> is the HTTP status response code for the request, (and other fields in <code>HttpResponseContext</code> are also available, including headers, content, and errors)</p></li>
</ul>


<p>Note the first line; as one descends into specific convenience subclasses (such as for Java web-apps), the work done by the parent class's overridden methods may be relevant, and will want to be invoked or even added to a resulting list.</p>

<p>For some sensors, and often at compound entities, the values are obtained by monitoring values of other sensors on the same (in the case of a rolling average) or different (in the case of the average of children nodes) entities. This is achieved by policies, described below.</p>

<p><a name="implementing-effectors"></a></p>

<h2>Implementing Effectors</h2>

<p>The <code>Entity</code> implementation defines the sensors and effectors available, the wiring for the sensors,
and in simple cases it may be straightforward to capture the behaviour of the effectors in methods.
For example deploying a WAR to a cluster can be done as follows:</p>

<p><em>This section is not complete. Feel free to <a href="/dev/code">fork</a> the docs and lend a hand.</em></p>

<!---
TODO show an effector which recurses across children
-->


<p>For some entities, specifically base entities, the implementation of effectors might need other tools (such as SSH), and may vary by location, so having a single implementation is not appropriate.</p>

<p>The problem of multiple inheritance (e.g. SSH functionality and entity inheritance) and multiple implementations (e.g. SSH versus Windows) is handled in brooklyn using delegates called <em>drivers</em>.</p>

<p>In the implementations of <code>JavaWebApp</code> entities, the behaviour which the entity always does is captured in the entity class (for example, breaking deployment of multiple WARs into atomic actions), whereas implementations which is specific to a particular entity and driver (e.g. using scp to copy the WARs to the right place and install them, which of course is different among appservers, or using an HTTP or JMX management API, again where details vary between appservers) is captured in a driver class.</p>

<p>Routines which are convenient for specific drivers can then be inherited in the driver class hierarchy. For example, when passing JMX environment variables to Java over SSH, <code>JavaStartStopSshDriver</code> extends <code>StartStopSshDriver</code> and parents <code>JBoss7SshDriver</code>.</p>

<!---
TODO more drivers such as whirr, jmx, etc are planned
-->


<p><a name="testing"></a></p>

<h2>Testing</h2>

<ul>
<li>Run in a mock <code>SimulatedLocation</code>, defining new metaclass methods to be able to start there and assert the correct behaviour when that is invoked</li>
</ul>



        </div><!--maincontent-->
        
      <div id="sidebar">
      


  






<div id="sidebar_toc">

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/start/index.html"><div class="toc-1-item">Start</div></a>
  
      </div>

    
    
    
	  <div class="toc-1 toc-active">
  
	    <a href="/use/guide/index.html"><div class="toc-1-item toc-1-header ">User Guide</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/quickstart/index.html"><div class="toc-2-item">Quick Start</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/defining-applications/basic-concepts.html"><div class="toc-2-item toc-2-header">Defining Applications</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/defining-applications/basic-concepts.html"><div class="toc-3-item">Basic Concepts</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/defining-applications/advanced-concepts.html"><div class="toc-3-item">Advanced Concepts</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/defining-applications/common-usage.html"><div class="toc-3-item">Common Usage</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/management/index.html"><div class="toc-2-item toc-2-header">Management</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#introduction"><div class="toc-3-item">Introduction</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#startup-config"><div class="toc-3-item">Startup Configuration</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#cli"><div class="toc-3-item">Command Line Interface</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#console"><div class="toc-3-item">Management Web Console</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#observation-other"><div class="toc-3-item">Observation APIs</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#distributed-management"><div class="toc-3-item">Distributed Management</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#resilience"><div class="toc-3-item">Resilience</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#key-apis"><div class="toc-3-item">Key APIs</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html#sensors-and-effectors"><div class="toc-3-item">Sensors and Effectors</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/policies/index.html"><div class="toc-2-item toc-2-header">Policies</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/policies/index.html#introduction"><div class="toc-3-item">Introduction</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/policies/index.html#writing-policies"><div class="toc-3-item">Writing Policies</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/policies/index.html#off-the-shelf-policies"><div class="toc-3-item">Off-the-Shelf Policies</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/policies/index.html#implementing-policies"><div class="toc-3-item">Implementing Policies</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 toc-active">
      
	        <a href="/use/guide/entities/index.html"><div class="toc-2-item toc-2-header toc-active">Custom Entities</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#entity-lifestyle"><div class="toc-3-item">Entity Lifecycle</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#implementation-classes"><div class="toc-3-item">What to Extend</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#configuration"><div class="toc-3-item">Configuration</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#implementing-sensors"><div class="toc-3-item">Implementing Sensors</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#implementing-effectors"><div class="toc-3-item">Implementing Effectors</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html#testing"><div class="toc-3-item">Testing</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/extras/index.html"><div class="toc-2-item toc-2-header">Extras</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html#web"><div class="toc-3-item">Web</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html#database"><div class="toc-3-item">Database</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html#nosql"><div class="toc-3-item">NoSQL</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html#messaging"><div class="toc-3-item">Messaging</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html#provisioning"><div class="toc-3-item">Provisioning</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/start/index.html"><div class="toc-1-item toc-1-header ">Elsewhere</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/examples/index.html"><div class="toc-2-item toc-2-header">Examples</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/webcluster/index.html"><div class="toc-3-item">Elastic Web Cluster</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/global-web-fabric/index.html"><div class="toc-3-item">Global Web Fabric</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/whirrhadoop/index.html"><div class="toc-3-item">Whirr Hadoop Cluster</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/portable-cloudfoundry/index.html"><div class="toc-3-item">Portable Cloud Foundry</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/messaging/index.html"><div class="toc-3-item">Publish-Subscribe Messaging</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/api/index.html"><div class="toc-2-item">API Reference</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/code/index.html"><div class="toc-2-item toc-2-header">Contributing</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/dev/code/index.html"><div class="toc-3-item">The Code</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/build/index.html"><div class="toc-3-item">Build and Test</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/tips/index.html"><div class="toc-3-item">Tips and Tricks</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/wishlist.html"><div class="toc-3-item">Wishlist</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/links.html"><div class="toc-3-item">Links</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/how-to-contrib.html"><div class="toc-3-item">How to Contribute</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/license/index.html"><div class="toc-2-item">License</div></a>
      
          </div>
    
        </div>
  
      </div>
 
</div>
<br/>


      </div>

    </div><!--contentcontainer-->
        
    <div id="footer">
        <p id="copyright">
            <b>brooklyn is distributed under the Apache License v2.0.</b><br/>
            brooklyn is a registered trademark of Cloudsoft Corporation.<br/>
            &copy; 2012 Cloudsoft Corporation.
        </p>
    </div><!--footer -->

</div><!--container-->

</body>
</html>
