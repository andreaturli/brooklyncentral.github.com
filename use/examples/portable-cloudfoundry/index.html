<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<head>
  <title>Portable Cloud Foundry Web Cluster</title>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />

  <link rel="stylesheet" href="/style/style.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/style/toc.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/style/docs/code.css" type="text/css" media="screen" />

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  
	<!-- Sidebar/ToC Scripts and CSS -->
	<script src="/style/js/jquery/jquery-1.7.1.min.js"></script>
	<script src="/style/js/jquery/jquery-ui-1.8.18.custom.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/style/js/jquery/smoothness/jquery-ui-1.8.18.custom.css" />
	
	<script type="text/javascript" src="/style/js/superfish.js"></script>
	
<!-- Clipboard support -->
<script src="/style/js/zeroclipboard/ZeroClipboard.js"></script>
<style type="text/css">
.clipboard_container { float: right; padding: 8px; }
.clipboard_button {
    background-image: url("/style/icons/clipboard-green-normal.png");
    background-size: 18px 21px;
    width: 18px; height: 21px;
}
.clipboard_button.hover  { background-image: url("/style/icons/clipboard-green-hover.png"); }
.clipboard_button.active  { background-image: url("/style/icons/clipboard-green-click.png"); }'
</style>
<script type="text/javascript"> <!-- clipboard -->
ZeroClipboard.setMoviePath( '/style/js/zeroclipboard/ZeroClipboard.swf' );
</script>
<script type="text/javascript"> <!-- clipboard positioning -->
$(document).ready(function() {
  $('<div class="clipboard_container" title="Copy to Clipboard">'+
    '<div class="clipboard_button"/>'+
  '</div>').insertBefore($('div.highlight'))
  $('div.clipboard_container').each(function(index) {
    var clipboard = new ZeroClipboard.Client();
    clipboard.glue( $(this).find(":first")[0], $(this)[0] );
    var target = $(this).next();
    var txt = target.text().trim();
    if (target.find('code.bash')) {
      txt = txt.replace(/^[^%$]*[%$] /, "").replace(new RegExp('\n[^%$]*[%$] ','g'), "\n");
    }
    clipboard.setText(txt);
  });
});
</script>

    <script type="text/javascript">
        // initialise menu delay
        jQuery(function(){
            jQuery('ul#mainmenu').superfish({ 
                autoArrows:  false,  // disable generation of arrow mark-up 
                dropShadows: false,  // disable drop shadows 
                disableHI:   true,   // set to true to disable hoverIntent detection 
                delay:       500,    // the delay in milliseconds that the mouse can remain outside a submenu without it closing 
                speed:       'fast', 
            });
        });
    </script>

<script type="text/javascript"> <!-- search -->
	$(function() {
		$('#simple_google')
			.submit(function() {
				$('input[name="q"]').val("site:" + document.location.hostname + " " + $('input[name="brooklyn-search"]').val());
			return true;
			});
		$('input[name="brooklyn-search"]').focus(function() {
				if ($(this).val() === $(this).attr('placeholder')) {
					$(this).val('');
				}
			})
			.blur(function() {
				if ($(this).val() === '') {
					$(this).val($(this).attr('placeholder'));
				}
			})
			.blur();
    });
</script>

<script type="text/javascript"> <!-- analytics -->
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-30530918-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</head>

<body>

    <ul id="shortcuts" title="Accessibility shortcuts menu">
        <li><a href="#maincontent">Skip to main content</a></li>
    </ul>
   

<div id="container">

    <div id="header">
    
        <div id="identity">
            <a href="http://brooklyncentral.github.com/" rel="home">Brooklyn</a>
        </div>
        
        <ul id="quicklinks">
            <li><a href="/meta/contact.html">Contact</a></li>
            <li><a href="/start/download.html">Download</a></li>
            <li><a href="https://twitter.com/#!/search?q=brooklyncentral">Twitter</a></li>
            <li><a href="https://github.com/brooklyncentral">GitHub</a></li>
        </ul>

        <div id="menubar">  







<ul id="mainmenu"><!-- INSERT LINKS -->
            

  
  
  <li class=""><a href="/index.html">Overview</a></li>

  
  
  <li class=""><a href="/start/download.html">Download</a></li>

  
  
  <li class=""><a href="/start/walkthrough/index.html">Walkthrough</a></li>

  
  
  <li class=""><a href="/use/guide/index.html">Guide</a></li>

  
  
  <li class="toc-active"><a href="/use/examples/index.html">Examples</a></li>

  
  
  <li class=""><a href="/dev/code/index.html">Contributing</a></li>


</ul>                    

            <form method="get" id="simple_google" class="searchform" action="http://www.google.com/search" method="get">
                <input type="text" class="searchinput" name="brooklyn-search" placeholder="Search: type &amp; hit enter" />
                <input type="hidden" name="q" value="" />
            </form>
            
        </div>
                
    </div><!--header-->
    
    <div id="contentcontainer">
    
        <div id="maincontent">


  







    
    
        
        
    
        
        
    
        
        
    
        
        
    

    
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
                
                
                
                
                
                
            
        
            
        
    
        
        
    
        
        
    

    
    
        
        
            
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
    
        
        
            
        
            
        
            
        
            
        
    
        
        
    
        
        
            
        
            
        
            
        
    
        
        
    

    
    
        
        
    
        
        
            
        
            
        
            
        
            
        
            
        
            
        
    

    
    
        
        
    
        
        
    
        
        
    



            
<p id="breadcrumb">
    <a href="/use/index.html">Using brooklyn</a>
    
        &raquo; <a href="/use/examples/index.html">Examples</a>
        
            &raquo; <a href="/use/examples/portable-cloudfoundry/index.html">Portable Cloud Foundry</a>
        
    
</p>


<h1 id="header_title">Portable Cloud Foundry Web Cluster</h1>
    
<p>The example <a href="../webcluster">Simple Web Cluster</a> showed
how to build a web cluster from load balancers and web servers.
This example shows how Brooklyn can be used to make this interoperate
with Java WebApp PaaS offerings such as Cloud Foundry.</p>

<p>This example will also cover how to write a new high-level entity,
implementing a "move" effector to move a webapp between CF locations.</p>

<p><strong>Writing new entities requires intermediate Java skills (and slightly more work)
than defining an application. On the plus side, entities are much easier to re-use!</strong></p>

<h2>Before You Begin</h2>




<p>To use the examples, you'll need <code>curl</code>, <code>java</code>, and <code>maven</code> (v3) installed.</p>




<p>First, grab a copy of the Brooklyn distribution:</p>




<div class="highlight"><pre><code class="bash"><span class="c"># download and unpack</span>
curl -L http://developers.cloudsoftcorp.com/maven/releases/io/brooklyn/brooklyn-dist/0.4.0-M2/<span class="se">\</span>
brooklyn-dist-0.4.0-M2-dist.tar.gz | tar xzf -
<span class="c"># set up an environment variable to point to it for convenience</span>
<span class="nb">export </span><span class="nv">BROOKLYN_HOME</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/brooklyn
</code></pre>
</div>




<p>Then, grab a copy of the brooklyn-examples source code and build with Maven:</p>




<div class="highlight"><pre><code class="bash"><span class="c"># download and unpack</span>
curl -L https://github.com/brooklyncentral/brooklyn-examples/tarball/0.4.0-M2 | tar xzf -
<span class="c"># set up an environment variable to point to it for convenience</span>
<span class="nb">export </span><span class="nv">BROOKLYN_EXAMPLES_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/brooklyncentral-brooklyn-examples-b296711
<span class="c"># build with Maven</span>
<span class="nb">cd</span> <span class="k">${</span><span class="nv">BROOKLYN_EXAMPLES_DIR</span><span class="k">}</span>
mvn clean install
</code></pre>
</div>




<p>For more information about where to download brooklyn please
see the <a href="/start/download.html">download page</a>.</p>




<p>If you wish to learn more about the Brooklyn CLI used for launching an app,
please visit <a href="/use/guide/management/index.html#cli">this section of the user guide</a>.</p>


<p>The CLI needs to know where to find your compiled examples. You can set this up by exporting
the <code>BROOKLYN_CLASSPATH</code> environment variable in the following way:</p>

<div class="highlight"><pre><code class="bash"><span class="nb">export </span><span class="nv">BROOKLYN_CLASSPATH</span><span class="o">=</span><span class="k">${</span><span class="nv">BROOKLYN_EXAMPLES_DIR</span><span class="k">}</span>/portable-cloudfoundry/target/classes
</code></pre>
</div>


<p>The project <code>${BROOKLYN_EXAMPLES_DIR}/portable-cloudfoundry</code> contains the code used
in this example in <code>src/main/java</code>.</p>

<h2>Deploying to Cloud Foundry</h2>

<p>Let's start by showing how the <code>ElasticJavaWebAppService</code> can start
a java webapp in VMware's Cloud Foundry PaaS, just as easily as creating it
from scratch in a VM-based cloud.
We'll create our application in a Groovy class <code>MovableCloudFoundryClusterExample</code>:</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovableCloudFoundryClusterExample</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_LOCATION</span> <span class="o">=</span> <span class="s">&quot;cloudfoundry&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">WAR_FILE_URL</span> <span class="o">=</span> <span class="s">&quot;classpath://hello-world-webapp.war&quot;</span><span class="o">;</span>

    <span class="n">ElasticJavaWebAppService</span> <span class="n">websvc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ElasticWebAppService</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nl">war:</span> <span class="n">WAR_FILE_URL</span><span class="o">);</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MovableCloudFoundryClusterExample</span><span class="o">(</span><span class="nl">name:</span><span class="err">&#39;</span><span class="n">Movable</span> <span class="n">Web</span> <span class="n">Cluster</span><span class="err">&#39;</span><span class="o">);</span>
        <span class="n">BrooklynLauncher</span><span class="o">.</span><span class="na">manage</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">new</span> <span class="n">LocationRegistry</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="s">&quot;cloudfoundry&quot;</span><span class="o">)</span> <span class="o">);</span>
        <span class="n">Entities</span><span class="o">.</span><span class="na">dumpInfo</span><span class="o">(</span><span class="n">app</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>


<p>We supply the location spec string <code>"cloudfoundry"</code> instead of
jclouds VM locations <code>"cloudservers-uk"</code> or <code>"aws-ec2:us-west-1"</code>;
apart from that the code is unchanged.
Logic in <code>"ElasticJavaWebAppService"</code> determines the appropriate strategy for any cloud.
You can supply a specific Cloud Foundry endpoint by appending <code>:endpoint</code>;
it defaults to <code>"cloudfoundry:api.cloudfoundry.com"</code>.
The current implementation requires that <code>"vmc"</code> is installed and logged in to the
endpoint(s) you use.</p>

<p><a href="webapp.png"><img src="webapp-750px.png" title="Web App at cloudfoundry.com" alt="Web App at cloudfoundry.com" /></a></p>

<h2>A <code>Move</code> Effector</h2>

<p>The word <code>Movable</code> in the class name we just chose is misleading, so far;
let's now correct that by defining a <code>move(String location)</code> effector.
Because this effector might be fairly useful, we will define it in an interface
which can be easily picked up by any entity,
and invoked programmatically, in Java or a REST API, or by an operator in the web console.</p>

<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MovableEntityTrait</span> <span class="o">{</span>

    <span class="n">Effector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">MOVE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodEffector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">MovableEntityTrait</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;move&quot;</span><span class="o">);</span>
            
    <span class="cm">/** Effectively move the entity to the new location.</span>
<span class="cm">     * A new entity may be created (and the old destroyed) to effect this.</span>
<span class="cm">     * @param location the new location where the entity should running</span>
<span class="cm">     * @return the entity ID of the primary entity (after the move) in the specified location */</span>
    <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;Effectively move the entity to the new location.&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">move</span><span class="o">(</span>
            <span class="nd">@NamedParameter</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">)</span> 
            <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;The new location where the entity should be running&quot;</span><span class="o">)</span> 
            <span class="n">String</span> <span class="n">location</span><span class="o">);</span>

<span class="o">}</span>
</code></pre>
</div>


<p>The interface method declaration should be familiar.
The <code>@Description</code>and <code>@NamedParamter</code> annotations (from <code>brooklyn.entity.basic</code>)
facilitate self-documenting runtime usage (aka the web console).
The static field <code>MOVE</code> may seem unusual, but this pattern, used for sensors,
effectors, and config keys, simplifies discovery and makes pure-Java closure-style invocation more natural
(see, for example, <code>Entities.invokeEffectorList</code>).
Groovy users should note that the <code>MethodEffector</code> constructor alternatively
accepts the method-reference notation, <code>new MethodEffector&lt;String&gt;(MovableEntityTrait.&amp;move)</code>.</p>

<h2>Preparing Our Movable Cluster</h2>

<p>With this defined, let us create an entity which implements <code>Movable</code>, and otherwise
simply wraps a webapp cluster.
We start with the <code>Startable</code> interface methods (effectors),
with an implementation that delegates to an <code>ElasticJavaWebAppService</code> entity,
creating it if necessary, and advertising its ID through a sensor.</p>

<div class="highlight"><pre><code class="java"><span class="nd">@InheritConstructors</span>
<span class="kd">class</span> <span class="nc">MovableElasticWebAppCluster</span> <span class="kd">extends</span> <span class="n">AbstractEntity</span> <span class="kd">implements</span> <span class="n">Startable</span><span class="o">,</span> <span class="n">MovableEntityTrait</span> <span class="o">{</span>

    <span class="nd">@SetFromFlag</span><span class="o">(</span><span class="s">&quot;war&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">BasicConfigKey</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ROOT_WAR</span> <span class="o">=</span> <span class="n">JavaWebAppService</span><span class="o">.</span><span class="na">ROOT_WAR</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">BasicAttributeSensor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">PRIMARY_SVC_ENTITY_ID</span> <span class="o">=</span> 
            <span class="o">[</span> <span class="n">String</span><span class="o">,</span> <span class="s">&quot;movable.primary.id&quot;</span><span class="o">,</span> <span class="s">&quot;Entity ID of primary web-app service&quot;</span> <span class="o">];</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Location</span><span class="o">&gt;</span> <span class="n">locations</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">getOwnedChildren</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Starting $this; it already has children, so start on children is being invoked&quot;</span><span class="o">)</span>
            <span class="n">StartableMethods</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">locations</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Entity</span> <span class="n">svc</span> <span class="o">=</span> <span class="n">createClusterIn</span><span class="o">(</span> <span class="n">Iterables</span><span class="o">.</span><span class="na">getOnlyElement</span><span class="o">(</span><span class="n">locations</span><span class="o">)</span> <span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Starting $this; no children, so created $svc and now starting it&quot;</span><span class="o">)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">svc</span> <span class="n">in</span> <span class="n">Startable</span><span class="o">)</span> <span class="o">((</span><span class="n">Startable</span><span class="o">)</span><span class="n">svc</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">locations</span><span class="o">);</span>
            <span class="n">setAttribute</span><span class="o">(</span><span class="n">PRIMARY_SVC_ENTITY_ID</span><span class="o">,</span> <span class="n">svc</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">EntityLocal</span> <span class="nf">createClusterIn</span><span class="o">(</span><span class="n">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ElasticJavaWebAppService</span><span class="o">.</span><span class="na">Factory</span><span class="o">().</span>
            <span class="n">newFactoryForLocation</span><span class="o">(</span><span class="n">location</span><span class="o">).</span>
            <span class="n">newEntity</span><span class="o">([:],</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">StartableMethods</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restart</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">StartableMethods</span><span class="o">.</span><span class="na">restart</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">move</span><span class="o">(</span><span class="n">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</code></pre>
</div>


<p>Note also that we define the <code>ROOT_WAR</code> config key here,
with a flag, so that users can easily specify the config value on this entity
(with configuration being inherited by descendant entities such as the wrapped cluster).<br/>
This means we could run our new entity by changing one line in the
<code>MovableCloudFoundryClusterExample</code> application above
(although of course <code>move</code> will throw an exception):</p>

<div class="highlight"><pre><code class="java">    <span class="n">MovableElasticWebAppCluster</span> <span class="n">websvc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MovableElasticWebAppCluster</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nl">war:</span> <span class="n">WAR_FILE_URL</span><span class="o">);</span>
</code></pre>
</div>


<p><a href="console-sensors.png"><img src="console-sensors-750px.png" title="MovableElasticWebAppCluster Entity Hierarchy and CloudFoundryJavaWebAppCluster Sensors" alt="MovableElasticWebAppCluster Entity Hierarchy and CloudFoundryJavaWebAppCluster Sensors" /></a></p>

<h2>Like to Move It Move It</h2>

<p>Now for the fun part:  let's implement the <code>move</code> effector.
While this could be done as a single method, in order to provide seamless
transitioning (even allowing for DNS services to update) we will break down the
logical move operation into the following steps:</p>

<ol>
<li>Create and start a <em>secondary</em> cluster</li>
<li>Promote the secondary cluster so that it becomes primary, and demote the former primary cluster to be secondary</li>
<li>Destroy the demoted cluster</li>
</ol>


<p>This allows dependent operations, such as DNS reconfiguration,
to be aware of completion of these individual steps -- e.g. by listening to sensors such as the ID of the primary cluster, or the IDs of the secondaries.
You might, for instance, defer the destory step,
leaving the secondary active (and possibly configured so if forwards to the primary),
until DNS updates have finished propagating.</p>

<p>Let's add these three steps as effectors, along with a sensor for <code>Collection&lt;String&gt; SECONDARY_SVC_ENTITY_IDS</code>.
First, we'll create a secondary cluster:</p>

<div class="highlight"><pre><code class="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">BasicAttributeSensor</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">SECONDARY_SVC_ENTITY_IDS</span> <span class="o">=</span> 
            <span class="o">[</span> <span class="n">List</span><span class="o">,</span> <span class="s">&quot;movable.secondary.ids&quot;</span><span class="o">,</span> <span class="s">&quot;Entity IDs of secondary web-app services&quot;</span> <span class="o">];</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Effector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">CREATE_SECONDARY_IN_LOCATION</span> <span class="o">=</span> 
            <span class="k">new</span> <span class="n">MethodEffector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.&amp;</span><span class="n">createSecondaryInLocation</span><span class="o">);</span>
    
    <span class="cm">/** creates a new secondary instance, in the given location, </span>
<span class="cm">     * returning the ID of the secondary created and started */</span>
    <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;create a new secondary instance in the given location&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createSecondaryInLocation</span><span class="o">(</span>
            <span class="nd">@NamedParameter</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">)</span> 
            <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;the location where to start the secondary&quot;</span><span class="o">)</span>
            <span class="n">String</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
            
        <span class="n">Location</span> <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationRegistry</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
        <span class="n">Entity</span> <span class="n">svc</span> <span class="o">=</span> <span class="n">createClusterIn</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="n">Entities</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">managementContext</span><span class="o">,</span> <span class="n">svc</span><span class="o">,</span> <span class="o">[</span><span class="n">location</span><span class="o">]);</span>
        <span class="n">setAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">,</span> <span class="o">(</span><span class="n">getAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">)</span> <span class="o">?:</span> <span class="o">[])</span> <span class="o">+</span> <span class="n">svc</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">svc</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>


<p>Next, we'll promote that cluster and demote the former primary, emitting sensors
for the new primaries and set of secondaries:</p>

<div class="highlight"><pre><code class="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Effector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">PROMOTE_SECONDARY</span> <span class="o">=</span> 
            <span class="k">new</span> <span class="n">MethodEffector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.&amp;</span><span class="n">promoteSecondary</span><span class="o">);</span>
    
    <span class="cm">/** promotes the indicated secondary,</span>
<span class="cm">     * returning the ID of the former-primary which has been demoted */</span>
    <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;promote the indicated secondary to primary (demoting the existing primary)&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">promoteSecondary</span><span class="o">(</span>
            <span class="nd">@NamedParameter</span><span class="o">(</span><span class="s">&quot;idOfSecondaryToPromote&quot;</span><span class="o">)</span> 
            <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;ID of secondary entity to promote&quot;</span><span class="o">)</span>
            <span class="n">String</span> <span class="n">idOfSecondaryToPromote</span><span class="o">)</span> <span class="o">{</span>
            
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentSecondaryIds</span> <span class="o">=</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">currentSecondaryIds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">idOfSecondaryToPromote</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                    <span class="s">&quot;Cannot promote unknown secondary $idOfSecondaryToPromote &quot;</span><span class="o">+</span>
                    <span class="s">&quot;(available secondaries are $currentSecondaryIds)&quot;</span><span class="o">);</span>
            
        <span class="n">String</span> <span class="n">primaryId</span> <span class="o">=</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">PRIMARY_SVC_ENTITY_ID</span><span class="o">);</span>
        
        <span class="n">setAttribute</span><span class="o">(</span><span class="n">PRIMARY_SVC_ENTITY_ID</span><span class="o">,</span> <span class="n">idOfSecondaryToPromote</span><span class="o">);</span>
        <span class="n">currentSecondaryIds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">idOfSecondaryToPromote</span><span class="o">);</span>
        <span class="n">currentSecondaryIds</span> <span class="o">&lt;&lt;</span> <span class="n">primaryId</span><span class="o">;</span>
        <span class="n">setAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">,</span> <span class="n">currentSecondaryIds</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">primaryId</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>


<p>Step 3 is to destroy the demoted secondary.
(Or you could choose to leave it in place, with a minimal footprint,
achieved by a resizer policy scaling it back when it isn't being consumed.)</p>

<div class="highlight"><pre><code class="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Effector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">DESTROY_SECONDARY</span> <span class="o">=</span> 
            <span class="k">new</span> <span class="n">MethodEffector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.&amp;</span><span class="n">destroySecondary</span><span class="o">);</span>
    
    <span class="cm">/** destroys the indicated secondary */</span>
    <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;destroy the indicated secondary&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroySecondary</span><span class="o">(</span>
            <span class="nd">@NamedParameter</span><span class="o">(</span><span class="s">&quot;idOfSecondaryToDestroy&quot;</span><span class="o">)</span> 
            <span class="nd">@Description</span><span class="o">(</span><span class="s">&quot;ID of secondary entity to destroy&quot;</span><span class="o">)</span>
            <span class="n">String</span> <span class="n">idOfSecondaryToDestroy</span><span class="o">)</span> <span class="o">{</span>
            
        <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentSecondaryIds</span> <span class="o">=</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">currentSecondaryIds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">idOfSecondaryToDestroy</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                    <span class="s">&quot;Cannot promote unknown secondary $idOfSecondaryToDestroy &quot;</span><span class="o">+</span>
                    <span class="s">&quot;(available secondaries are $currentSecondaryIds)&quot;</span><span class="o">);</span>
            
        <span class="n">currentSecondaryIds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">idOfSecondaryToDestroy</span><span class="o">);</span>
        <span class="n">setAttribute</span><span class="o">(</span><span class="n">SECONDARY_SVC_ENTITY_IDS</span><span class="o">,</span> <span class="n">currentSecondaryIds</span><span class="o">);</span>
        
        <span class="n">Entity</span> <span class="n">secondary</span> <span class="o">=</span> <span class="n">getManagementContext</span><span class="o">().</span><span class="na">getEntity</span><span class="o">(</span><span class="n">idOfSecondaryToDestroy</span><span class="o">);</span>
        <span class="n">Entities</span><span class="o">.</span><span class="na">destroy</span><span class="o">(</span><span class="n">managementContext</span><span class="o">,</span> <span class="n">secondary</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>


<p>And finally, we'll define <code>move</code>, as the sequence of the three effectors above:</p>

<div class="highlight"><pre><code class="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">move</span><span class="o">(</span><span class="n">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">newPrimary</span> <span class="o">=</span> <span class="n">createSecondaryInLocation</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">oldPrimary</span> <span class="o">=</span> <span class="n">promoteSecondary</span><span class="o">(</span><span class="n">newPrimary</span><span class="o">);</span>
        <span class="n">destroySecondary</span><span class="o">(</span><span class="n">oldPrimary</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">newPrimary</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>


<h2>Running It</h2>

<p>You can run the application using the provided shell script:</p>

<div class="highlight"><pre><code class="bash"><span class="k">${</span><span class="nv">BROOKLYN_HOME</span><span class="k">}</span>/bin/brooklyn launch <span class="se">\</span>
--app brooklyn.example.cloudfoundry.MovableCloudFoundryClusterExample --location localhost
</code></pre>
</div>


<p>Note that we have our webapp running in Cloud Foundry, and we have the effectors we've introduced exposed in the web console:</p>

<p><a href="console-sensors.png"><img src="console-sensors-750px.png" title="MovableElasticWebAppCluster Effectors" alt="MovableElasticWebAppCluster Effectors" /></a></p>

<p>By clicking <code>move</code> and specifying a location,
the webapp will come up at the new location and go down at the old.
This allows, for instance, moving from a CF micro-cloud to <code>cloudfoundry.com</code>,
or to a private install (including Stackato).
Supplying the same location (e.g. <code>"cloudfoundry"</code>) will cause
a new (different) instance to be created in the same location.
Or, as shown above, you can specify <code>"localhost"</code> or <code>"aws-ec2"</code> or any of
the targets shown in the <a href="../webcluster">Simple Web Cluster example</a>.</p>

<h2>Exercises for the Reader</h2>

<p>If you've completed this, you're probably ready for a bigger challenge.
Here are some ideas to get you started:</p>

<ol>
<li><p>Combine the <code>Movable</code> entity built here with
the <a href="../global-web-fabric">Global Web Fabric example</a>,
to make a fabric running our web-app, spanning multiple Cloud Foundry instances,
where each instance is able to be moved as well.</p></li>
<li><p>Consume a CF service, such as a database, in your web-app.
You'll have to modify or sub-class <code>CloudFoundryVmcCliAccess</code> and <code>CloudFoundryJavaWebAppService</code>
to allow the service to be specified via <code>vmc</code>.
What strategies can then be used to migrate application <em>data</em> when the app is moved?</p></li>
<li><p>Create a new Brooklyn CF entity to support an application other than a Java Web App.
The list is (almost) endless -- Ruby, node.js, PHP, etc.</p></li>
</ol>


<p>Is some of what you've built a worthy addition to Brooklyn?
If so please consider <a href="/dev/how-to-contrib.html">contributing it</a> so that we can make it better
and others can benefit.</p>


        </div><!--maincontent-->
        
      <div id="sidebar">
      


  






<div id="sidebar_toc">

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/start/index.html"><div class="toc-1-item toc-1-header ">Start</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/index.html"><div class="toc-2-item">Overview</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/start/walkthrough/index.html"><div class="toc-2-item">Walkthrough</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/start/download.html"><div class="toc-2-item">Download</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/start/docs-summary.html"><div class="toc-2-item">Documentation</div></a>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 toc-active">
  
	    <a href="/use/index.html"><div class="toc-1-item toc-1-header ">Using brooklyn</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/guide/index.html"><div class="toc-2-item toc-2-header">User Guide</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/quickstart/index.html"><div class="toc-3-item">Quick Start</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/defining-applications/basic-concepts.html"><div class="toc-3-item">Defining Applications</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/management/index.html"><div class="toc-3-item">Management</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/policies/index.html"><div class="toc-3-item">Policies</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/entities/index.html"><div class="toc-3-item">Custom Entities</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/guide/extras/index.html"><div class="toc-3-item">Extras</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 toc-active">
      
	        <a href="/use/examples/index.html"><div class="toc-2-item toc-2-header">Examples</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/webcluster/index.html"><div class="toc-3-item">Elastic Web Cluster</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/global-web-fabric/index.html"><div class="toc-3-item">Global Web Fabric</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/whirrhadoop/index.html"><div class="toc-3-item">Whirr Hadoop Cluster</div></a>
              </div>
        
            
              <div class="toc-3 toc-active">
	            <a href="/use/examples/portable-cloudfoundry/index.html"><div class="toc-3-item toc-active">Portable Cloud Foundry</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/use/examples/messaging/index.html"><div class="toc-3-item">Publish-Subscribe Messaging</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/api/index.html"><div class="toc-2-item">API Reference (javadoc)</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/use/contact.html"><div class="toc-2-item">Discuss</div></a>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/dev/code/index.html"><div class="toc-1-item toc-1-header ">Contributing</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/code/index.html"><div class="toc-2-item toc-2-header">The Code</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/dev/code/index.html"><div class="toc-3-item">Structure</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/code/entity.html"><div class="toc-3-item">Writing an Entity</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/code/policy.html"><div class="toc-3-item">Writing a Policy</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="http://github.com/brooklyncentral/brooklyn"><div class="toc-3-item">brooklyn.git (github)</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/build/index.html"><div class="toc-2-item toc-2-header">Build and Test</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/dev/build/index.html"><div class="toc-3-item">Maven</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/build/ide.html"><div class="toc-3-item">IDE</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/build/tests.html"><div class="toc-3-item">Tests</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/tips/index.html"><div class="toc-2-item toc-2-header">Tips and Tricks</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/dev/tips/index.html"><div class="toc-3-item">Miscellany</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/tips/logging.html"><div class="toc-3-item">Logging</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/tips/standards.html"><div class="toc-3-item">Code Standards</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/dev/tips/update-docs.html"><div class="toc-3-item">Updating Docs</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/wishlist.html"><div class="toc-2-item">Wishlist</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/links.html"><div class="toc-2-item toc-2-header">Links</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="https://github.com/brooklyncentral/"><div class="toc-3-item">Github repo</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="https://github.com/brooklyncentral/brooklyn/issues"><div class="toc-3-item">Github issues</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="http://ccweb.cloudsoftcorp.com/maven/libs-snapshot-local/io/brooklyn/"><div class="toc-3-item">Maven snapshots</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/dev/how-to-contrib.html"><div class="toc-2-item">How to Contribute</div></a>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/license/index.html"><div class="toc-1-item toc-1-header ">License</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/license/license.html"><div class="toc-2-item">Apache License v2.0</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/license/contributor-agreements/index.html"><div class="toc-2-item toc-2-header">Contributor Agreements</div></a>
            <div class="toc-2-children-popup"><div class="toc-2-children">
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/index.html"><div class="toc-3-item">Instructions</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/individual.html"><div class="toc-3-item">Individual CLA (echosign)</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/corporate.html"><div class="toc-3-item">Corporate CLA (echosign)</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/corporate-update-schedule.html"><div class="toc-3-item">CCLA Schedule A Update (echosign)</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/brooklyn-icla.txt"><div class="toc-3-item">Individual CLA (raw text)</div></a>
              </div>
        
            
              <div class="toc-3 ">
	            <a href="/license/contributor-agreements/brooklyn-ccla.txt"><div class="toc-3-item">Corporate CLA (raw text)</div></a>
              </div>
        
            </div></div>
      
          </div>
    
        </div>
  
      </div>

    
    
    
	  <div class="toc-1 ">
  
	    <a href="/meta/governance.html"><div class="toc-1-item toc-1-header ">Meta</div></a>
        <div class="toc-1-children">
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/meta/governance.html"><div class="toc-2-item">Governance</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/meta/versions.html"><div class="toc-2-item">Versions</div></a>
      
          </div>
    
        
        
	      <div class="toc-2 ">
      
	        <a href="/meta/contact.html"><div class="toc-2-item">Contact</div></a>
      
          </div>
    
        </div>
  
      </div>
 
</div>
<br/>


      </div>

    </div><!--contentcontainer-->
        
    <div id="footer">
        <p id="copyright">
            <b>brooklyn is distributed under the Apache License v2.0.</b><br/>
            brooklyn is a registered trademark of Cloudsoft Corporation.<br/>
            &copy; 2012 Cloudsoft Corporation.
        </p>
    </div><!--footer -->

</div><!--container-->

</body>
</html>
